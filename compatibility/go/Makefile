#
# Makefile for the pyvider-cty Go compatibility tool
#

# Go command
GO_CMD := go

# Source directory for the tool
TOOL_SRC := .

# Default directory for Go-generated fixtures for Python to consume
FIXTURE_DIR_GO ?= ../../tests/fixtures/go-cty

.PHONY: all tidy generate verify clean

# Default target
all: tidy

# Tidy and download Go modules to ensure dependencies are consistent and available
tidy:
	@echo " tidying Go modules..."
	@$(GO_CMD) mod tidy
	@echo " downloading Go modules..."
	@$(GO_CMD) mod download

# Generate Go -> Python fixtures
# This target builds and runs the Go tool to create .msgpack files that the
# Python test suite will use to verify its deserialization logic.
generate: tidy
	@echo " generating Go fixtures in $(FIXTURE_DIR_GO)..."
	@mkdir -p $(FIXTURE_DIR_GO)
	@$(GO_CMD) run $(TOOL_SRC) generate --directory $(FIXTURE_DIR_GO)

# Verify Python -> Go fixtures
# This target is used to run the Go tool's verifier against fixtures
# generated by the Python scripts. It requires the DIR variable to be set.
# Example: make verify DIR=/tmp/py-fixtures
verify: tidy
	@if [ -z "$(DIR)" ]; then \
		echo "Error: DIR variable is not set. Usage: make verify DIR=/path/to/python/fixtures"; \
		exit 1; \
	fi
	@echo " verifying Python fixtures in $(DIR)..."
	@$(GO_CMD) run $(TOOL_SRC) verify --directory $(DIR)

# Clean up generated Go fixtures
clean:
	@echo " cleaning Go fixtures from $(FIXTURE_DIR_GO)..."
	@rm -f $(FIXTURE_DIR_GO)/*.msgpack
